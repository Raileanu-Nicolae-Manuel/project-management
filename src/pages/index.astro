---
import Layout from '@layouts/root.astro';
import { getSession } from 'auth-astro/server';
import { db } from 'astro:db';

const session = await getSession(Astro.request);

if (!session) {
  return Astro.redirect('/login');
}

// Fetch repositories from our API endpoint instead
const response = await fetch(`${Astro.url.origin}/api/repositories`);
const repositories = await response.json();
---

<Layout>
  {session ? (
    <div>
      <p>Welcome {session.user?.name}</p>
      <h2>Your Repositories:</h2>
      <ul>
        {repositories.map((repo: any) => (
          <li>
            <a href={`/project/${repo.id}`}>
              {repo.name} - {repo.description}
            </a>
          </li>
        ))}
      </ul>
    </div>
  ) : (
    <p>Not logged in</p>
  )}
</Layout>


